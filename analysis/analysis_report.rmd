---
title: "Analysis_Report"
author: "Daniel Pearson"
date: "11 April 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(R.matlab)
library(afex)
library(emmeans)
library(here)
library(patchwork)
library(cowplot)
library(BayesFactor)
library(hrbrthemes)
library(ggsignif)

vmacCols <- vmac_pal()
my_theme <- theme_ipsum_rc(grid = F, axis_title_just = "c", axis_title_size = 14, axis_text_size = 12, strip_text_size = 14, plot_title_size = 14, subtitle_size = 14, ticks = T) +
  theme(legend.position = "none", 
        plot.margin = margin(.5,1,.5,1,"cm"),
        axis.line = element_line(colour = "black", size = .5),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_line(colour = "black", size = .5),
        #aspect.ratio = 1.1,
        plot.tag = element_text(size = 20, family = font_rc),
        axis.title = element_text(margin = margin(12,1,1,1, unit = "cm")),
        axis.text.x = element_text(margin = margin(t = 4, unit = 'pt'), colour = 'black'),
        axis.text.y = element_text(margin = margin(r = 4, unit = 'pt'), colour = 'black'),
        axis.title.x = element_text(margin = margin(t = 8, unit = 'pt')),
        axis.title.y = element_text(margin = margin(r = 8, unit = 'pt')),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 14))

```

# Behavioural Analysis

```{r Load Behavioural Data, include=FALSE}
files <- dir(path = here::here("analysis", "data", "raw_data", "BehavData"), pattern = "*.mat")

filedata <- here::here("analysis", "data", "raw_data", "BehavData", files) %>%
  map(readMat) %>%
  map("DATA")
```

```{r Tidy Behavioural Data, include = FALSE}
#This is some messy code that lets us tidy the exptTrialInfo data from the nested .mat struct files

subNums <- filedata %>%
  map(1) %>%
  flatten() %>%
  map_dbl(1)

exptdata <- filedata %>%
  map(24) %>%
  map(2) %>%
  modify(as.data.frame)
  
counterbals <- filedata %>%
  map(2) %>%
  flatten() %>%
  map_dbl(1)

ages <- filedata %>%
  map(10) %>%
  flatten() %>%
  map_dbl(1)

ages_summ <- ages %>%
  tibble() %>% 
  rename("age" = ".")%>%
  summarise(m = mean(age, na.rm = T), stdev = sd(age))

bonuses <- filedata %>%
  map(17) %>%
  flatten() %>% 
  map_dbl(1)

bonuses_sum <- bonuses %>%
  tibble() %>% 
  rename("bonus" = ".") %>%
  summarise(m = mean(bonus, na.rm = T), stdev = sd(bonus))

genders <- filedata %>%
  map(11) %>%
  flatten()  %>%
  map_chr(1) %>%
  tolower()

genders_summ <- genders %>%
  as.factor() %>% 
  tibble() %>% 
  rename("gender" = ".") %>%
  count(gender)

exptdata <- Map(cbind, exptdata, sub = subNums, counterbal = counterbals, age = ages, gender = genders) %>%
  bind_rows()

colnames(exptdata)[1:24] <- c("block", "trial", "trialCounter", "trials_since_break", "targetLoc", "targetType", "distractLoc", "distractShape", "distractType", "fixationTime", "fixationPropGoodSamples", "fixationTimeout", "trialPropGoodSamples", "timeout", "softTimeoutTrial", "omissionTrial", "rt", "trialPay", "sessionPay", paste("timeOnLoc", c(1:5))) 

exptdata <- exptdata %>%
  mutate(condition = if_else(counterbal %in% c(1,2), "Singleton Search", "Feature Search")) 

exptdata <- exptdata %>% 
  mutate(gender = tolower(gender)) %>% 
  mutate(dType = factor(distractType, levels = c(1,2,3), labels = c("High", "Low", "Absent")))
```

```{r Remove participants with poor gaze data}
propCutoff <- .5
allTracks <- exptdata %>%
  group_by(sub) %>%
  summarise(fixationProp = mean(fixationPropGoodSamples),
            trialProp = mean(trialPropGoodSamples)) 

poortracks <- allTracks %>%
  filter(fixationProp < propCutoff | trialProp < propCutoff)

allTracks <- allTracks %>%
  filter(!sub %in% poortracks$sub)

allTracks_summ <- allTracks %>%
  summarise(mean_fixation_prop = round(mean(fixationProp)*100, 1), sd_fixation_prop = round(sd(fixationProp)*100, 1), mean_trial_prop = round(mean(trialProp)*100, 1), sd_trial_prop = round(sd(trialProp)*100,1))

exptdata <- exptdata %>%
 filter(!sub %in% poortracks$sub)
```

We removed data for any participants who did not have sufficient quality gaze data. If participants have an average of less than `r propCutoff*100`% valid gaze data during the fixation period or during a trial, they are removed from the data set.

`r length(poortracks)` participants were removed due to having a poor track.

```{r Remove participants for any other reasons}

remove_p_numbers <- c(37)

#  check to make sure that everyone has completed the full 480 trials
didNotComplete <- exptdata %>%
  group_by(sub) %>%
  filter(block > 0) %>%
  tally() %>%
  filter(n < 480) %>%
  select(sub)

# remove those that did not complete the full expt
remove_p_numbers <- c(remove_p_numbers, didNotComplete$sub)

exptdata <- exptdata %>%
  filter(!sub %in% remove_p_numbers)
```

`r length(remove_p_numbers)` participants were removed for other reasons (participant #37 they thought that they needed to look at the coloured circle in order to earn rewards, participant #26 and #85 did not complete the experiment due to difficulty tracking their eyes).

Then we remove the first two trials of the experiment, the first two trials after breaks, and timeouts from the data (in line with previous VMAC analysis protocols):

```{r Additional data exclusions}
# first we determine the percentage of trials that were timeouts (for reporting in the MS)
hardtimeouts <- exptdata %>%
  group_by(timeout) %>%
  summarise(n = n()) %>%
  mutate(perc = round(n/sum(n)*100, 1))

exptdata <- exptdata %>%
  filter(trial > 2 & trials_since_break > 2) %>% #removing first two trials and trials after breaks
  filter(timeout != 1) # removing timeouts
```

## Omission Trials
```{r Omission Trial Means}
exptdata_means_byparticipant <- exptdata %>%
  ungroup() %>%
  group_by(sub, condition, dType) %>%
  summarise(m = mean(omissionTrial))

exptdata_means_bycondition <- summarySEwithin2(data = exptdata_means_byparticipant, measurevar = "m", betweenvars = "condition", withinvars = "dType", idvar = "sub") %>%
  select(-ends_with("Normed"))
```


```{r Omission Trial Graph}


omissionPlot_singleton <- exptdata %>%
  filter(condition == "Singleton Search") %>%
  group_by(sub, dType) %>%
  summarise(m = mean(omissionTrial)) %>%
  ggplot(aes(x = dType, y = m, fill = dType, shape = dType)) +
  geom_errorbar(data = filter(exptdata_means_bycondition, condition == "Singleton Search"), aes(x = dType, y = m, ymin = m-se, ymax = m+se), colour = "black", width = .15) +
  geom_line(aes(group = sub), colour = "black", alpha = .1, linetype = "solid", size = .5) +
  geom_line(data = filter(exptdata_means_bycondition, condition == "Singleton Search"), aes(x = dType, y = m, group = 1), colour = "black") + 
  geom_point(data = filter(exptdata_means_bycondition, condition == "Singleton Search"), aes(x = dType, y = m), colour = "black", size = 3) +
  geom_signif(comparisons = list(c("High", "Low"), c("Low", "Absent")), annotations = c("***","*"), y_position = c(.61,.57), colour = "black", tip_length = 0) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), expand = c(0,0), limits = c(0,.8)) +
  scale_x_discrete(labels = c("High\nreward", "Low\nreward", "Distractor\nabsent")) +
  scale_fill_manual(values = vmacCols) +
  scale_colour_manual(values = vmacCols) +
  scale_shape_manual(name = "Trial Type", guide = guide_legend(), values = c(21,22,23)) +
  labs(y = "% Reward Omissions", x = "Trial Type", tag = "A", title = "Singleton Search") +
  my_theme

omissionPlot_feature <- 
  exptdata %>%
  filter(condition == "Feature Search") %>%
  group_by(sub, dType) %>%
  summarise(m = mean(omissionTrial)) %>%
  ggplot(aes(x = dType, y = m, fill = dType, shape = dType)) +
  geom_line(aes(group = sub), colour = "black", alpha = .1, linetype = "solid", size = .5) +
  geom_errorbar(data = filter(exptdata_means_bycondition, condition == "Feature Search"), aes(x = dType, y = m, ymin = m-se, ymax = m+se), colour = "black", width = .15) +
  geom_line(data = filter(exptdata_means_bycondition, condition == "Feature Search"), aes(x = dType, y = m, group = 1), colour = "black") + 
  geom_point(data = filter(exptdata_means_bycondition, condition == "Feature Search"), aes(x = dType, y = m), colour = "black", size = 3) +
  geom_signif(comparisons = list(c("High", "Low"), c("Low", "Absent")), annotations = c("***","***"), y_position = c(.61,.57), colour = "black", tip_length = 0) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), expand = c(0,0), limits = c(0,.8)) +
  scale_x_discrete(labels = c("High\nreward", "Low\nreward", "Distractor\nabsent")) +
  scale_fill_manual(values = vmacCols) +
  scale_shape_manual(name = "Distractor Type", guide = guide_legend(), values = c(21,22,23)) +
  labs(y = "% Reward Omissions", x = "Trial Type", tag = "B", title = "Feature Search") +
  my_theme

omissionPlot_ms <- omissionPlot_singleton / omissionPlot_feature

save_plot(here::here("analysis", "figures", "omission_plot.png"), omissionPlot_ms, ncol = 1, nrow = 2, type = "cairo", base_aspect_ratio = 1.1, dpi = 300)

omissionPlot_ms

```

### Effect of Reward
Effect of reward ANOVA:
```{r Effect of Reward - Omissions}
omissions_vmac.ANOVA <- aov_car(m ~ condition*dType + Error(sub/dType), data = filter(exptdata_means_byparticipant, dType != "Absent"), anova_table = list(es="pes"))
```
Significant main effect of reward (indicating VMAC effect), but no interaction with or main effect of search condition.

Planned t-tests:
```{r Effect of Reward - Omissions - Planned t-tests}
singleton_high_omissions <- exptdata_means_byparticipant %>%
  ungroup() %>%
  filter(condition == "Singleton Search") %>%
  filter(dType == "High") %>%
  select(m) %>%
  pull()

singleton_low_omissions <-  exptdata_means_byparticipant %>%
  ungroup() %>%
  filter(condition == "Singleton Search") %>%
  filter(dType == "Low") %>%
  select(m) %>%
  pull()

singleton_absent_omissions <- exptdata_means_byparticipant %>%
  ungroup() %>%
  filter(condition == "Singleton Search") %>%
  filter(dType == "Absent") %>%
  select(m) %>%
  pull()

feature_high_omissions <- exptdata_means_byparticipant %>%
  ungroup() %>%
  filter(condition == "Feature Search") %>%
  filter(dType == "High") %>%
  select(m) %>%
  pull()

feature_low_omissions <-  exptdata_means_byparticipant %>%
  ungroup() %>%
  filter(condition == "Feature Search") %>%
  filter(dType == "Low") %>%
  select(m) %>%
  pull()

feature_absent_omissions <- exptdata_means_byparticipant %>%
  ungroup() %>%
  filter(condition == "Feature Search") %>%
  filter(dType == "Absent") %>%
  select(m) %>%
  pull()

singleton_VMAC_omissions.ttest <- t.test(singleton_high_omissions, singleton_low_omissions, paired = T)
singleton_VMAC_omissions.es <- dz_calculator(singleton_high_omissions, singleton_low_omissions)
feature_VMAC_omissions.ttest <- t.test(feature_high_omissions, feature_low_omissions, paired = T)
feature_VMAC_omissions.es <- dz_calculator(feature_high_omissions, feature_low_omissions)

vmac_singleton <- exptdata_means_byparticipant %>%
  filter(dType != "Absent", condition == "Singleton Search") %>%
  spread(dType, m) %>%
  mutate(vmac = High - Low) %>%
  pull(vmac)

vmac_feature <- exptdata_means_byparticipant %>%
  filter(dType != "Absent", condition == "Feature Search") %>%
  spread(dType, m) %>%
  mutate(vmac = High - Low) %>%
  pull

vmac_condition_bayes <- ttestBF(x = vmac_singleton, y = vmac_feature)
```


### Effect of Physical Salience
Effect of physical salience ANOVA:
```{r Effect of Physical Salience - Omissions}
omissions_salience.ANOVA <- aov_car(m ~ condition*dType + Error(sub/dType), data = filter(exptdata_means_byparticipant, dType != "High"), anova_table = list(es="pes"))

omissions_salience.ANOVA
```

Planned t-tests:
```{r Effect of Physical Salience - Omissions - Planned t-tests}
singleton_physicalsalience_omissions.ttest <- t.test(singleton_low_omissions, singleton_absent_omissions, paired = T)

singleton_physicalsalience_omissions.es <- dz_calculator(singleton_low_omissions, singleton_absent_omissions)

feature_physicalsalience_omissions.ttest <- t.test(feature_absent_omissions, feature_low_omissions, paired = T) # reverse the order here so can get positive t value

feature_physicalsalience_omissions.es <- dz_calculator(feature_low_omissions, feature_absent_omissions)
```

# Gaze Data Analyses

```{r Load Gaze Data, include=FALSE}
saccade_files <- dir(path = here::here("analysis", "data", "derived_data","ProcessedSaccadeData"), pattern = "^S")

saccade_filedata <- here::here("analysis", "data", "derived_data","ProcessedSaccadeData", saccade_files) %>%
  map(readMat) %>%
  map("saccadeSessionData") %>%
  map(1) %>%
  map(2) %>%
  modify(as.data.frame)
```

```{r Tidy Gaze Data, include = FALSE}
# collapse the data into a dataframe format
saccade_filedata <- saccade_filedata %>%
  map_df(bind_rows)

# give the columns appropriate headers
colnames(saccade_filedata)[1:13] <- c("subj", "trial", "latency", paste("loc", c(1:5), sep = "_"), "discardTrial", "anticipatorySaccade", "outsideFixation", "noSaccades", "noValidData")

discardSaccadeCounter <- saccade_filedata %>%
  mutate(bad_data_discard = case_when(noSaccades == 1 ~ 1,
                                      noValidData == 1 ~ 1,
                                      TRUE ~ 0)) %>%
  group_by(subj) %>%
  summarise(prop_discarded = mean(discardTrial)*100, prop_anticipatory = mean(anticipatorySaccade)*100, prop_outside_fix = mean(outsideFixation)*100, prop_bad_data = mean(bad_data_discard)*100)

totalSaccadeTrialsDiscarded <- discardSaccadeCounter %>%
  summarise_all(mean) %>%
  summarise_all(round, 1)

saccade_filedata <- saccade_filedata %>%
  filter(discardTrial != 1) %>% # discard trials marked to be discarded
  mutate(first_saccade_loc = loc_1*1+loc_2*2+loc_3*3+loc_4*4+loc_5*5) 

saccadedata <- left_join(exptdata, saccade_filedata, by = c("sub" = "subj", "trial" = "trial")) %>% #join saccade data up with behavioural data
  mutate(saccade_to_target = if_else(targetLoc == first_saccade_loc, 1, 0)) %>% # create variables indicating whether first saccade went towards the target...
  mutate(saccade_to_singleton = if_else(dType == "Absent", 2, 
                                        if_else(distractLoc == first_saccade_loc, 1, 0))) %>% # singleton (for all except distractor absent trials)
  mutate(saccade_to_singleton = replace(saccade_to_singleton, saccade_to_singleton == 2, NA)) %>%
  mutate(saccade_to_nonsingleton = if_else((dType != "Absent" & targetLoc != first_saccade_loc & distractLoc != first_saccade_loc & first_saccade_loc < 5) | (dType == "Absent" & targetLoc != first_saccade_loc & first_saccade_loc < 5), 1, 0)) %>% # or non-singleton
  mutate(num_nonsingletons = if_else(dType == "Absent", 3, 2)) # add the number of nonsingletons for each trial type
```


## First saccade direction
```{r First saccade direction - means}
# calculate summary statistics for each participant
saccadeData_means_byparticipant <- saccadedata %>%
  ungroup() %>%
  mutate(sub = as.factor(sub)) %>%
  group_by(sub, condition, dType) %>%
  summarise(saccade_to_target = mean(saccade_to_target, na.rm = T),
            saccade_to_singleton = mean(saccade_to_singleton, na.rm = T),
            saccade_to_nonsingleton = mean(saccade_to_nonsingleton, na.rm = T)/mean(num_nonsingletons, na.rm = T),
            num_nonsingletons = mean(num_nonsingletons, na.rm = T))

targetmeans <- summarySEwithin2(data = saccadeData_means_byparticipant, measurevar = "saccade_to_target", betweenvars = "condition", withinvars = c("dType"), idvar = "sub", na.rm = T) %>%
  rename(proportionSaccades = saccade_to_target) %>%
  mutate(stimType = "Target") %>%
  select(-ends_with("Normed"))

singletonmeans <- summarySEwithin2(data = saccadeData_means_byparticipant, measurevar = "saccade_to_singleton", betweenvars = "condition", withinvars = c("dType"), idvar = "sub", na.rm = T) %>%
  rename(proportionSaccades = saccade_to_singleton) %>%
  mutate(stimType = "Singleton")%>%
  select(-ends_with("Normed"))

nonsingletonmeans <- summarySEwithin2(data = saccadeData_means_byparticipant, measurevar = "saccade_to_nonsingleton", betweenvars = "condition", withinvars = c("dType"), idvar = "sub", na.rm = T) %>%
  rename(proportionSaccades = saccade_to_nonsingleton) %>%
  mutate(stimType = "Nonsingleton")%>%
  select(-ends_with("Normed"))

# collapse together
saccadeData_means_bycondition <- bind_rows(targetmeans, singletonmeans, nonsingletonmeans) %>%
  mutate(stimType = factor(stimType, levels = c("Target","Nonsingleton","Singleton")))

saccadePlotDataParticipants <- gather(saccadeData_means_byparticipant, key = "stimType", value = "proportionSaccades", starts_with("saccade_to")) %>%
  mutate(stimType = case_when(stimType == "saccade_to_target" ~ "Target",
                              stimType == "saccade_to_nonsingleton" ~ "Nonsingleton",
                              stimType == "saccade_to_singleton" ~ "Singleton",
                              TRUE ~ ""))

captureData_means_byparticipant <- saccadeData_means_byparticipant %>%
  filter(dType != "Absent") %>%
  mutate(Capture = saccade_to_singleton - saccade_to_nonsingleton)
  
captureMeans <- summarySEwithin2(captureData_means_byparticipant, measurevar = "Capture", betweenvars = "condition", withinvars = "dType", idvar = "sub") %>%
  select(-ends_with("Normed"))
```

```{r First Saccade Direction - Plot, echo = FALSE}
saccadePlot_singleton <- saccadeData_means_bycondition %>%
  filter(condition == "Singleton Search", dType != "Absent") %>%
  ggplot(aes(group = dType, y = proportionSaccades, fill = dType, x = stimType, shape = dType, colour = dType)) +
  geom_line(aes(linetype = dType, colour = dType), na.rm = T, size = .5, position = position_dodge(width = .6)) +
  geom_point(aes(group = dType, y = proportionSaccades, x = stimType), na.rm = T, size = 1.5, alpha = .3, stroke = F, data = filter(saccadePlotDataParticipants, condition == "Singleton Search", dType != "Absent"), position = position_jitterdodge(dodge.width = .6, jitter.width = .2)) +
  geom_errorbar(aes(ymin = proportionSaccades-se, ymax = proportionSaccades+se), na.rm = T, linetype = "solid", position = position_dodge(width = .6, preserve = "total"), show.legend = FALSE, colour = "black", width = .3) +
  geom_point(na.rm = T, size = 3, position = position_dodge(width = .6), colour = "black") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), expand = c(0,0), limits = c(0,.8)) +
  scale_linetype_manual(name = "Trial Type", values = c("solid", "longdash", "dotdash"), guide = guide_legend(), labels = c("High-reward", "Low-reward")) +
  scale_fill_manual(name = "Trial Type", values = vmacCols, labels = c("High-reward", "Low-reward")) +
  scale_colour_manual(name = "Trial Type", values = vmacCols, labels = c("High-reward", "Low-reward")) +
  scale_shape_manual(name = "Trial Type", guide = guide_legend(), values = c(21,22,23), labels = c("High-reward", "Low-reward")) +
  ylab("% First Saccades") + xlab("Stimulus Type") + labs(tag = "A", title = "Singleton Search") +
  my_theme

saccadePlot_feature <- saccadeData_means_bycondition %>%
  filter(condition == "Feature Search", dType != "Absent") %>%
  ggplot(aes(group = dType, y = proportionSaccades, fill = dType, x = stimType, shape = dType, colour = dType)) +
  geom_line(aes(linetype = dType, colour = dType), na.rm = T, size = .5, position = position_dodge(width = .6)) +
  geom_point(aes(group = dType, y = proportionSaccades, x = stimType), na.rm = T, size = 1.5, alpha = .3, stroke = F, data = filter(saccadePlotDataParticipants, condition == "Feature Search", dType != "Absent"), position = position_jitterdodge(dodge.width = .6, jitter.width = .2)) +
  geom_errorbar(aes(ymin = proportionSaccades-se, ymax = proportionSaccades+se), na.rm = T, linetype = "solid", position = position_dodge(width = .6, preserve = "total"), show.legend = FALSE, colour = "black", width = .3) +
  geom_point(na.rm = T, size = 3, position = position_dodge(width = .6), colour = "black") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), expand = c(0,0), limits = c(0,.8)) +
  scale_linetype_manual(name = "Distractor Type", values = c("solid", "longdash", "dotdash"), guide = guide_legend()) +
  scale_fill_manual(name = "Distractor Type", values = vmacCols) +
  scale_colour_manual(name = "Distractor Type", values = vmacCols) +
  scale_shape_manual(name = "Distractor Type", guide = guide_legend(), values = c(21,22,23)) +
  ylab("% First Saccades") + xlab("Stimulus Type") + labs(tag = "C", title = "Feature Search") +
  my_theme

legend_saccade <- get_legend(saccadePlot_singleton + theme(legend.position = "bottom",
                                                           legend.title = element_text(size = 14),
                                                           legend.text = element_text(size = 14),
                                                           legend.key.width = unit(24, 'pt')))
 

## Capture Bar Plots
captureBarPlot_singleton <- captureMeans %>%
  filter(condition == "Singleton Search") %>%
  mutate(annotation = c("***", " ")) %>%
  ggplot(aes(x = dType, y = Capture, fill = dType)) +
  annotate(geom = "text", label = "Capture", x = 2.85, y = .15, angle = 90, vjust = 1, hjust = .5, family = font_rc) +
  annotate(geom = "text", label = "Suppression", x = 2.85, y = -.15, angle = 90, vjust = 1, hjust = .5, family = font_rc) +
  annotate(geom = "segment", x = 2.65, xend = 2.65, y = -.03, yend = -.27, arrow = arrow(type = 'closed', length = unit(6, 'pt'))) +
  annotate(geom = "segment", x = 2.65, xend = 2.65, y = .03, yend = .27, arrow = arrow(type = 'closed', length = unit(6, 'pt'))) +
  geom_col(position = position_dodge(.9), size = .3) +
  geom_hline(yintercept = 0, color = "black", size = .5) +
  geom_errorbar(aes(ymax = Capture + se, ymin = Capture - se), position = position_dodge(.9), width = .1) +
  geom_text(aes(label = annotation), nudge_y = .05) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), expand = c(0,0), limits = c(-.3001, .3001)) +
  scale_x_discrete(labels = c("High\nreward", "Low\nreward")) +
  coord_cartesian(xlim = c(1,2),
                  clip = 'off') +
  scale_fill_manual(name = "Distractor Type", values = vmacCols, guide = guide_legend()) +
  ylab("Capture Score") + xlab("Trial Type") + labs(tag = "B") +
  my_theme 

captureBarPlot_feature <- 
  captureMeans %>%
  filter(condition == "Feature Search") %>%
  mutate(annotation = c("***", "*")) %>%
  ggplot(aes(x = dType, y = Capture, fill = dType)) +
  annotate(geom = "text", label = "Capture", x = 2.85, y = .15, angle = 90, vjust = 1, hjust = .5, family = font_rc) +
  annotate(geom = "text", label = "Suppression", x = 2.85, y = -.15, angle = 90, vjust = 1, hjust = .5, family = font_rc) +
  annotate(geom = "segment", x = 2.65, xend = 2.65, y = -.03, yend = -.27, arrow = arrow(type = 'closed', length = unit(6, 'pt'))) +
  annotate(geom = "segment", x = 2.65, xend = 2.65, y = .03, yend = .27, arrow = arrow(type = 'closed', length = unit(6, 'pt'))) +
  geom_col(position = position_dodge(.9), size = .3) + 
  geom_hline(yintercept = 0, size = .5) +
  geom_errorbar(aes(ymax = Capture + se, ymin = Capture - se), position = position_dodge(.9), width = .1) +
  geom_text(aes(label = annotation), nudge_y = c(.05, .07)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1), expand = c(0,0), limits = c(-.3001, .3001)) +
  scale_x_discrete(labels = c("High\nreward", "Low\nreward")) +
  coord_cartesian(xlim = c(1,2),
                  clip = 'off') +
  scale_fill_manual(name = "Distractor Type", values = vmacCols, guide = guide_legend()) +
  ylab("Capture Score") + xlab("Trial Type") + labs(tag = "D") +
  my_theme

saccadePlot_ms_row1 <- saccadePlot_singleton + captureBarPlot_singleton + plot_spacer() + plot_layout(nrow = 1, widths = c(2,1,.1))

saccadePlot_ms_row2 <- saccadePlot_feature + captureBarPlot_feature + plot_spacer() + plot_layout(nrow = 1, widths = c(2,1,.1))

saccadePlot_ms <- saccadePlot_ms_row1 / legend_saccade / saccadePlot_ms_row2 + plot_layout(heights = c(1,.1,1))

save_plot(here("analysis", "figures", "saccade_plot.png"), saccadePlot_ms, ncol = 2, nrow = 2, type = "cairo", base_aspect_ratio = .9, dpi = 300)

saccadePlot_ms
```


```{r First Saccade Direction - Capture ANOVA}
capture.ANOVA <- aov_car(Capture ~ condition*dType + Error(sub/dType), data = captureData_means_byparticipant,  anova_table = list(es="pes"))

capture.ANOVA

# Bayes Factor for interaction contrast
captureData_wide <- captureData_means_byparticipant %>%
  select(sub, condition, dType, Capture) %>%
  spread(dType, Capture) %>%
  mutate(vmac = High - Low)

capture_bayes <- ttestBF(x = captureData_wide$vmac[captureData_wide$condition == "Singleton Search"], 
                         y = captureData_wide$vmac[captureData_wide$condition == "Feature Search"])

1/capture_bayes

```

```{r First Saccade Direction - Planned t-tests}
Singleton_high.ttest <- captureData_means_byparticipant %>%
  ungroup() %>%
  filter(condition == "Singleton Search") %>%
  filter(dType == "High") %>%
  select(Capture) %>%
  pull() %>%
  t.test()

Singleton_high.es <- captureData_means_byparticipant %>%
  ungroup() %>%
  filter(condition == "Singleton Search") %>%
  filter(dType == "High") %>%
  select(Capture) %>%
  summarise(mean_capture = mean(Capture), sd_capture = sd(Capture), d_z = mean_capture/sd_capture) %>%
  pull(d_z)

Singleton_low.ttest <- captureData_means_byparticipant %>%
  ungroup() %>%
  filter(condition == "Singleton Search") %>%
  filter(dType == "Low") %>%
  select(Capture) %>%
  pull() %>%
  t.test()

Singleton_low.es <- captureData_means_byparticipant %>%
  ungroup() %>%
  filter(condition == "Singleton Search") %>%
  filter(dType == "Low") %>%
  select(Capture) %>%
  summarise(mean_capture = mean(Capture), sd_capture = sd(Capture), d_z = mean_capture/sd_capture) %>%
  pull(d_z)

Feature_high.ttest <- captureData_means_byparticipant %>%
  ungroup() %>%
  filter(condition == "Feature Search") %>%
  filter(dType == "High") %>%
  select(Capture) %>%
  pull() %>%
  t.test()

Feature_high.es <- captureData_means_byparticipant %>%
  ungroup() %>%
  filter(condition == "Feature Search") %>%
  filter(dType == "High") %>%
  select(Capture) %>%
  summarise(mean_capture = mean(Capture), sd_capture = sd(Capture), d_z = mean_capture/sd_capture) %>%
  pull(d_z)

Feature_low.ttest <- captureData_means_byparticipant %>%
  ungroup() %>%
  filter(condition == "Feature Search") %>%
  filter(dType == "Low") %>%
  select(Capture) %>%
  pull() %>%
  t.test()

Feature_low.ttest$statistic <- Feature_low.ttest$statistic*-1 # just making the t value positive for reporting in the manuscript

Feature_low.es <- captureData_means_byparticipant %>%
  ungroup() %>%
  filter(condition == "Feature Search") %>%
  filter(dType == "Low") %>%
  select(Capture) %>%
  summarise(mean_capture = mean(Capture), sd_capture = sd(Capture), d_z = abs(mean_capture/sd_capture)) %>%
  pull(d_z)
```

## Development of suppression/capture effect across blocks

```{r Block Analysis Data Tidying}
saccadeData_means_byparticipant_byblock <- 
  saccadedata %>%
  mutate(sub = as.factor(sub), newblock = ceiling(as.numeric(block)/2)) %>%
  group_by(sub, condition, dType, newblock) %>%
  summarise(saccade_to_target = mean(saccade_to_target, na.rm = T),
            saccade_to_singleton = mean(saccade_to_singleton, na.rm = T),
            saccade_to_nonsingleton = mean(saccade_to_nonsingleton, na.rm = T)/mean(num_nonsingletons, na.rm = T),
            num_nonsingletons = mean(num_nonsingletons, na.rm = T),
            capture = saccade_to_singleton - saccade_to_nonsingleton) %>%
  filter(dType != "Absent")

capturemeans_byblock <- summarySEwithin2(data = saccadeData_means_byparticipant_byblock, measurevar = "capture", betweenvars = "condition", withinvars = c("dType", "newblock"), idvar = "sub", na.rm = T) %>%
  select(-ends_with("Normed"))
```

```{r Block Analysis Graph}
capturePlot_byblock_singleton <- 
  capturemeans_byblock %>%
  filter(condition == "Singleton Search") %>%
  ggplot(aes(x = newblock, y = capture, group = dType, shape = dType, colour = dType)) +
  #geom_rect(fill = "#D3D3D3", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = 0, alpha = .3, inherit.aes = F) +
  geom_hline(yintercept = 0, colour = "black", size = .5, linetype = "dotted") +
  annotate(geom = "text", label = "Capture", x = 4.7, y = .15, angle = 90, vjust = 1, hjust = .5, family = font_rc) +
  annotate(geom = "text", label = "Suppression", x = 4.7, y = -.15, angle = 90, vjust = 1, hjust = .5, family = font_rc) +
  annotate(geom = "segment", x = 4.5, xend = 4.5, y = -.03, yend = -.27, arrow = arrow(type = 'closed', length = unit(6, 'pt'))) +
  annotate(geom = "segment", x = 4.5, xend = 4.5, y = .03, yend = .27, arrow = arrow(type = 'closed', length = unit(6, 'pt'))) +
  geom_line(aes(linetype = dType), size = .5) +
  geom_errorbar(aes(ymin = capture - se, ymax = capture + se), width = .1, colour = "black") +
  geom_point(aes(shape = dType, fill = dType), size = 3, colour = "black") +
  scale_shape_manual(name = "Distractor Type", guide = guide_legend(), values = c(21,22)) +
  scale_fill_manual(name = "Distractor Type", values = vmacCols, guide = guide_legend()) +
  scale_colour_manual(name = "Distractor Type", values = vmacCols, guide = guide_legend()) +
  scale_y_continuous(expand = c(0,0), limits = c(-.3,.301), breaks = seq(-.3, .3, .1), labels = scales::percent_format(accuracy = 1)) +
  scale_x_discrete() +
  coord_cartesian(xlim = c(1,4),
                  clip = 'off') +
  scale_linetype_manual(name = "Distractor Type", values = c("solid", "longdash"), guide = guide_legend()) +
  ylab("Capture Score") + xlab("Epoch (96 trials)") + labs(tag = "A", title = 'Singleton Search') +
  my_theme

capturePlot_byblock_feature <- 
  capturemeans_byblock %>%
  filter(condition == "Feature Search") %>%
  ggplot(aes(x = newblock, y = capture, group = dType, shape = dType, colour = dType)) +
  geom_hline(yintercept = 0, colour = "black", size = .5, linetype = "dotted") +
  annotate(geom = "text", label = "Capture", x = 4.7, y = .15, angle = 90, vjust = 1, hjust = .5, family = font_rc) +
  annotate(geom = "text", label = "Suppression", x = 4.7, y = -.15, angle = 90, vjust = 1, hjust = .5, family = font_rc) +
  annotate(geom = "segment", x = 4.5, xend = 4.5, y = -.03, yend = -.27, arrow = arrow(type = 'closed', length = unit(6, 'pt'))) +
  annotate(geom = "segment", x = 4.5, xend = 4.5, y = .03, yend = .27, arrow = arrow(type = 'closed', length = unit(6, 'pt'))) +
  geom_line(aes(linetype = dType), size = .5) +
  geom_errorbar(aes(ymin = capture - se, ymax = capture + se), width = .1, colour = "black") +
  geom_point(aes(shape = dType, fill = dType), size = 3, colour = "black") +
  scale_shape_manual(name = "Distractor Type", guide = guide_legend(), values = c(21,22)) +
  scale_fill_manual(name = "Distractor Type", values = vmacCols, guide = guide_legend()) +
  scale_colour_manual(name = "Distractor Type", values = vmacCols, guide = guide_legend()) +
  scale_y_continuous(expand = c(0,0), limits = c(-.3,.301), breaks = seq(-.3, .3, .1), labels = scales::percent_format(accuracy = 1)) +
  scale_x_discrete() +
  coord_cartesian(xlim = c(1,4),
                  clip = 'off') +
  scale_linetype_manual(name = "Distractor Type", values = c("solid", "longdash"), guide = guide_legend()) +
  ylab("Capture Score") + xlab("Epoch (96 trials)") + labs(tag = "B", title = 'Feature Search') +
  my_theme

capturePlot_byblock_vert <- (capturePlot_byblock_singleton + plot_spacer() + plot_layout(widths = c(1,.1))) / legend_saccade / (capturePlot_byblock_feature + plot_spacer() + plot_layout(widths = c(1,.1))) + plot_layout(heights = c(1,.1,1))

capturePlot_byblock_vert

save_plot(here("analysis", "figures","capture_plot_by_block.png"), capturePlot_byblock_vert, ncol = 1, nrow = 2, type = "cairo", base_aspect_ratio = 1.1, dpi = 300)


```

```{r Block Analysis Statistics}
capture_byblock.ANOVA <- aov_car(capture ~ newblock*dType*condition + Error(sub/newblock*dType), data = saccadeData_means_byparticipant_byblock, anova_table = list(es="pes"))

capture_byblock.ANOVA

ref_all <- lsmeans(capture_byblock.ANOVA, ~newblock | dType)

capture_byblock.polys <- summary(contrast(ref_all, method = "poly")) %>%
  mutate(t.ratio = abs(t.ratio),
         df = round(df, digits = 0))

capture_byblock.polys
```

